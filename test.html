
<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SES-IAT: Final Optimiert</title>
  <script src="https://unpkg.com/jspsych@7.3.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response"></script>
  <script src="https://unpkg.com/@jspsych/plugin-call-function"></script>
  <script src="https://unpkg.com/@jspsych/plugin-preload"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: auto;
      padding: 2em;
      text-align: center;
    }
    .stimulus { font-size: 32px; margin-top: 1em; }
    .categories {
      display: flex;
      justify-content: space-between;
      font-weight: bold;
      font-size: 18px;
      margin-bottom: 1em;
    }
    @media (max-width: 600px) {
      .categories { font-size: 16px; flex-direction: column; gap: 10px; }
    }
  </style>
</head>
<body>
  <div id="jspsych-target"></div>
  <script>
    const jsPsych = initJsPsych();
    const armWords = ["Arbeitslosigkeit", "Betteln", "Gemeindebau", "Sozialhilfe"];
    const reichWords = ["Luxus", "Privatschule", "Geld", "Villa"];
    const guteWorte = ["Freude", "Liebe", "Wertvoll", "Erfolg"];
    const schlechteWorte = ["Leid", "Versagen", "Schmutz", "Schmerz"];
    const preload = { type: jsPsychPreload, images: [] };
    const timeline = [preload];

    function makeStimuli(words, category) {
      return words.map(w => ({ stimulus: w, category: category }));
    }
    function sampleStimuli(blockName, stimuli) {
      return jsPsych.randomization.shuffle(stimuli).map(s => ({ ...s, block: blockName }));
    }
    function buildTrial(leftCats, rightCats) {
      return {
        type: jsPsychHtmlKeyboardResponse,
        stimulus: function() {
          const stim = jsPsych.timelineVariable('stimulus', true);
          return `<div class="categories"><div>${leftCats.join(" / ")}</div><div>${rightCats.join(" / ")}</div></div><div class="stimulus">${stim}</div>`;
        },
        choices: ['e', 'i'],
        data: {
          category: function() { return jsPsych.timelineVariable('category', true); },
          block: jsPsych.timelineVariable('block')
        },
        trial_duration: null,
        trial_ends_after_response: true,
        post_trial_gap: 0,
        on_finish: function(data) {
          const correct = (data.category === "Arm" || data.category === "Gut") ? data.response === 'e' : data.response === 'i';
          data.correct = correct;
        }
      };
    }
    function makeInstruction(text) {
      return {
        type: jsPsychHtmlKeyboardResponse,
        stimulus: `<p>${text}</p><p>Drücken Sie eine Taste, um fortzufahren.</p>`,
        post_trial_gap: 0
      };
    }

    timeline.push(makeInstruction("SES-IAT – Starten Sie mit einer kurzen Übung zur Zuordnung von Arm vs. Reich."));
    const p1 = sampleStimuli("Übung: Arm vs. Reich", makeStimuli(armWords, "Arm").concat(makeStimuli(reichWords, "Reich")));
    timeline.push({ timeline: [buildTrial(["Arm"], ["Reich"])], timeline_variables: p1 });

    timeline.push(makeInstruction("Übung: Gut vs. Schlecht"));
    const p2 = sampleStimuli("Übung: Gut vs. Schlecht", makeStimuli(guteWorte, "Gut").concat(makeStimuli(schlechteWorte, "Schlecht")));
    timeline.push({ timeline: [buildTrial(["Gut"], ["Schlecht"])], timeline_variables: p2 });

    timeline.push(makeInstruction("Testblock 1: Arm + Gut (E) vs. Reich + Schlecht (I)"));
    const b1 = sampleStimuli("Testblock 1", makeStimuli(armWords, "Arm").concat(makeStimuli(guteWorte, "Gut"), makeStimuli(reichWords, "Reich"), makeStimuli(schlechteWorte, "Schlecht")));
    timeline.push({ timeline: [buildTrial(["Arm", "Gut"], ["Reich", "Schlecht"])], timeline_variables: b1 });

    timeline.push(makeInstruction("Neue Übung: Arm vs. Reich erneut"));
    const p3a = sampleStimuli("Übung 3.1", makeStimuli(armWords, "Arm").concat(makeStimuli(reichWords, "Reich")));
    timeline.push({ timeline: [buildTrial(["Arm"], ["Reich"])], timeline_variables: p3a });

    timeline.push(makeInstruction("Neue Übung: Schlecht vs. Gut erneut"));
    const p3b = sampleStimuli("Übung 3.2", makeStimuli(schlechteWorte, "Schlecht").concat(makeStimuli(guteWorte, "Gut")));
    timeline.push({ timeline: [buildTrial(["Schlecht"], ["Gut"])], timeline_variables: p3b });

    timeline.push(makeInstruction("Testblock 2: Arm + Schlecht (E) vs. Reich + Gut (I)"));
    const b2 = sampleStimuli("Testblock 2", makeStimuli(armWords, "Arm").concat(makeStimuli(schlechteWorte, "Schlecht"), makeStimuli(reichWords, "Reich"), makeStimuli(guteWorte, "Gut")));
    timeline.push({ timeline: [buildTrial(["Arm", "Schlecht"], ["Reich", "Gut"])], timeline_variables: b2 });

    // Puffer-Trial zur sicheren Weiterleitung nach letztem Test
    timeline.push({
      type: jsPsychHtmlKeyboardResponse,
      stimulus: "<p>Danke! Ihre Daten werden verarbeitet...</p>",
      choices: "NO_KEYS",
      trial_duration: 300
    });
    

    timeline.push({
      type: jsPsychCallFunction,
      func: function() {
        const data = jsPsych.data.get().filterCustom(d => d.block && d.block.includes("Testblock"));
        const block1 = data.filter({ block: "Testblock 1" }).select("rt").values;
        const block2 = data.filter({ block: "Testblock 2" }).select("rt").values;
        const avg = arr => arr.length ? arr.reduce((a, b) => a + b, 0) / arr.length : 0;
        const avg1 = avg(block1);
        const avg2 = avg(block2);
        const dScore = (avg1 - avg2) / Math.max(jsPsych.utils.standardDeviation(block1.concat(block2)), 1);
        let interpretation = "Keine eindeutige Tendenz.";
        if (Math.abs(dScore) > 0.65) {
          interpretation = dScore > 0 ? "Starke Tendenz: Reich + Gut bevorzugt." : "Starke Tendenz: Arm + Gut bevorzugt.";
        } else if (Math.abs(dScore) > 0.35) {
          interpretation = dScore > 0 ? "Leichte Tendenz: Reich + Gut bevorzugt." : "Leichte Tendenz: Arm + Gut bevorzugt.";
        }
        jsPsych.data.addProperties({ d_score: dScore, interpretation: interpretation });
      }
    });

    timeline.push({
      type: jsPsychHtmlKeyboardResponse,
      stimulus: function() {
        const data = jsPsych.data.get().values()[0];
        return `<h3>Ergebnis</h3><p>${data.interpretation}</p><p>D-Score: ${data.d_score.toFixed(3)}</p><p>Drücken Sie eine Taste, um zu beenden.</p>`;
      },
      post_trial_gap: 0
    });

    jsPsych.run(timeline);
  </script>
</body>
</html>
